---

- name: Playbook para configurar servidor NFS en CentOS
  hosts: centos
  become: yes

  vars:
    var_nfs_shared: /var/nfs_shared
    var_nfs_export: "/var/nfs_shared * (rw,sync,no_root_squash,no_subtree_check)"

  tasks: 

  - name: Instalacion paquete NFS
    ansible.builtin.dnf:
      name: nfs-utils
      state: present

  - name: Verificar servicio NFS habilitado e iniciado
    ansible.builtin.systemd_service:
      name: nfs-server
      enabled: true
      state: started

  - name: Habilitar puerto 2049 en firewall
    ansible.posix.firewalld:
      port: 2049/tcp
      permanent: true
      state: enabled
      immediate: true

  - name: Carpeta compartida
    ansible.builtin.file:
      path: "{{var_nfs_shared}}"
      state: directory
      owner: nobody
      group: nobody
      mode: '0777'

  - name: Garantiza que la linea de exportacion exista en el archivo
    ansible.builtin.lineinfile:
      path: /etc/exports
      line: "{{var_nfs_export}}"
      state: present
    notify: reload_export

  handlers:
   - name: reload_export
     command: exportfs -ra
      
